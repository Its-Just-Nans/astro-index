---
import { existsSync, statSync } from "fs";
import { readdir } from "fs/promises";
import { join } from "path";
import BackImg from "./assets/back.gif";
import FolderImg from "./assets/folder.gif";
import UnknownImg from "./assets/unknown.gif";

interface Props {
    path: string;
    title?: string;
    address?: string;
}
const { path = ".", title = `Index of ${path}`, address } = Astro.props;
if (!path) {
    throw new Error("path is required");
}
if (!existsSync(path)) {
    throw new Error(`astro-index path ${path} does not exist`);
}

const files = (await readdir(path)).sort();
---

<h1>{title}</h1>
<table>
    <tr>
        <th valign="top">
            <img src={FolderImg.src} alt="[ICO]" />
        </th>
        <th><a href="">Name</a></th>
        <th><a href="">Last modified</a></th>
        <th><a href="">Size</a></th>
        <th><a href="">Description</a></th>
    </tr>
    <tr>
        <th colspan="5"><hr /></th>
    </tr>
    <tr>
        <td valign="top">
            <img src={BackImg.src} alt="[PARENTDIR]" />
        </td>
        <td><a href="..">Parent Directory</a></td>
        <td>&nbsp;</td>
        <td align="right">-</td>
        <td>&nbsp;</td>
    </tr>
    {
        files.map((file) => {
            const stat = statSync(join(path, file));
            const isFolder = stat.isDirectory();
            const filePath = isFolder ? `${file}/` : file;
            return (
                <tr>
                    <td valign="top">
                        <img src={isFolder ? FolderImg.src : UnknownImg.src} alt="[]" />
                    </td>
                    <td>
                        <a href={filePath}>{file}</a>
                    </td>
                    <td align="right">{stat.mtime.toISOString()}</td>
                    <td align="right">{stat.size}</td>
                    <td>&nbsp;</td>
                </tr>
            );
        })
    }

    <tr>
        <th colspan="5"><hr /></th>
    </tr>
</table>
{
    (typeof address !== "undefined" && address) || (
        <address>
            List generated by <a href="https://github.com/Its-Just-Nans/astro-index">astro-index</a>
        </address>
    )
}
